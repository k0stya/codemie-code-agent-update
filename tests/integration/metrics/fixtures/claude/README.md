# Claude Metrics Test Fixtures

This directory contains real Claude Code session files used for integration testing of the Claude metrics adapter.

## Directory Structure

```
fixtures/claude/
├── README.md                      # This file
├── -tmp-private/                  # Claude session files (mirrors ~/.claude/projects/-tmp-private/)
│   ├── 4c2ddfdc-b619-4525-8d03-1950fb1b0257.jsonl  # Main session
│   ├── agent-36541525.jsonl                         # Sub-agent 1
│   └── agent-50243ee8.jsonl                         # Sub-agent 2
├── expected-session.json          # Expected CodeMie session metadata
└── expected-metrics.jsonl         # Expected CodeMie metrics deltas
```

## Files

### Input Files (Claude Session Data)

#### `-tmp-private/4c2ddfdc-b619-4525-8d03-1950fb1b0257.jsonl`
**Original**: `~/.claude/projects/-tmp-private/4c2ddfdc-b619-4525-8d03-1950fb1b0257.jsonl`

Main session file containing the primary conversation flow.

**Session ID**: `4c2ddfdc-b619-4525-8d03-1950fb1b0257`
**Working Directory**: `/tmp/private`
**Git Branch**: `analytics-v2`

**Test Scenario**:
1. User: "create hello.py, md and js"
   - Write hello.py (8 lines, Python)
   - Write hello.md (14 lines, Markdown)
   - Write hello.js (8 lines, JavaScript)

2. User: "update py with one liner comment"
   - Read hello.py
   - Edit hello.py (+1 line added: "# Simple hello world program")

3. User: "delete js"
   - Bash: `rm hello.js`

**Metrics Summary** (main session only):
- **Assistant turns**: 10 (with token usage)
- **Input tokens**: 42
- **Output tokens**: 806
- **Cache creation**: 177,370
- **Cache read**: 214,627
- **Model**: `claude-sonnet-4-5-20250929`
- **Tool calls**: 6 (3 Write + 1 Read + 1 Edit + 1 Bash)

#### `-tmp-private/agent-36541525.jsonl`
**Original**: `~/.claude/projects/-tmp-private/agent-36541525.jsonl`

Sub-agent (sidechain) file containing task planning/exploration.

**Agent ID**: `36541525`
**Session ID**: `4c2ddfdc-b619-4525-8d03-1950fb1b0257` (same as main)
**Is Sidechain**: `true`

**Metrics Summary**:
- **Assistant turns**: 1
- **Input tokens**: 3
- **Output tokens**: 3
- **Cache creation**: 16,976
- **Model**: `claude-sonnet-4-5-20250929`

#### `-tmp-private/agent-50243ee8.jsonl`
**Original**: `~/.claude/projects/-tmp-private/agent-50243ee8.jsonl`

Sub-agent (sidechain) file containing additional task execution.

**Agent ID**: `50243ee8`
**Session ID**: `4c2ddfdc-b619-4525-8d03-1950fb1b0257` (same as main)
**Is Sidechain**: `true`

**Metrics Summary**:
- **Assistant turns**: 1
- **Input tokens**: 16,878
- **Output tokens**: 237
- **Model**: `converse/jp.anthropic.claude-haiku-4-5-20251001-v1:0`

### Expected Output Files (CodeMie Generated)

#### `expected-session.json`
**Original**: `~/.codemie/metrics/sessions/71a17a83-ff99-4d05-964b-0bd56892faec.json`

Session metadata file generated by CodeMie's MetricsOrchestrator.

**CodeMie Session ID**: `71a17a83-ff99-4d05-964b-0bd56892faec`
**Agent Name**: `claude`
**Provider**: `ai-run-sso`
**Working Directory**: `/tmp/private`
**Status**: `active`

Contains:
- Session metadata (ID, agent, provider, timestamps)
- Correlation results (matched agent session file)
- Monitoring state (change detection)
- Sync state (processed records, line tracking)

#### `expected-metrics.jsonl`
**Original**: `~/.codemie/metrics/sessions/71a17a83-ff99-4d05-964b-0bd56892faec_metrics.jsonl`

Incremental metrics deltas generated by ClaudeMetricsAdapter and stored by DeltaWriter.

**Format**: JSONL (one MetricDelta per line)
**Deltas**: 11 (10 from main session + 1 from agent-50243ee8)

Note: This file has 11 deltas because it was generated before agent-36541525.jsonl existed. Current test generates 12 deltas (includes all agent files).

## Golden Dataset Expectations

When all input files are parsed together (main + both agent files), the expected totals are:

- **Total deltas**: 12 (10 main + 2 agent)
- **Total input tokens**: 16,923
- **Total output tokens**: 1,058
- **Total cache creation**: 159,346
- **Total cache read**: 214,627
- **Total tokens**: 391,954
- **Unique models**: 2 (Sonnet 4.5 + Haiku 4.5)
- **Tool calls**: 6 (3 Write + 1 Read + 1 Edit + 1 Bash)
- **File operations**: 5 (Bash doesn't create file operations)
- **Lines added**: 31 (8+14+8+1)

## Usage in Tests

The integration test `src/agents/plugins/__tests__/claude.metrics.integration.test.ts` uses these fixtures to validate:

### Phase 1: Parsing & Generation
1. **Parsing**: ClaudeMetricsAdapter correctly parses session and agent files
2. **Agent Discovery**: Automatically finds and includes agent files with matching sessionId
3. **Delta Extraction**: Extracts correct incremental metrics (tokens, tools, file ops)
4. **Disk Storage**: DeltaWriter correctly writes to JSONL format
5. **Data Integrity**: All fields preserved, sync status set correctly
6. **Calculations**: Token totals, tool counts, and file operations match golden dataset

### Phase 2: Comparison with Expected Output
7. **Structure Match**: Generated deltas have same structure as expected metrics file
8. **Token Accuracy**: Token calculations match real generated metrics
9. **RecordId Preservation**: UUIDs from original session are preserved
10. **Field Completeness**: All required fields present and valid

## Test Execution

The test copies fixtures to a temporary directory, parses them, generates metrics, and validates against expected output:

```bash
npm test -- src/agents/plugins/__tests__/claude.metrics.integration.test.ts
```

**Expected Result**: 31 passing tests ✅

## Regenerating Fixtures

To update fixtures with new session data:

```bash
# 1. Copy Claude session files (input) - preserving directory structure
cp ~/.claude/projects/PROJECT_HASH/SESSION_ID.jsonl \
   src/agents/plugins/__tests__/fixtures/claude/PROJECT_HASH/SESSION_ID.jsonl
cp ~/.claude/projects/PROJECT_HASH/agent-*.jsonl \
   src/agents/plugins/__tests__/fixtures/claude/PROJECT_HASH/

# 2. Copy CodeMie generated files (expected output)
# First, run codemie-code to generate metrics, then:
cp ~/.codemie/metrics/sessions/CODEMIE_SESSION_ID.json \
   src/agents/plugins/__tests__/fixtures/claude/expected-session.json
cp ~/.codemie/metrics/sessions/CODEMIE_SESSION_ID_metrics.jsonl \
   src/agents/plugins/__tests__/fixtures/claude/expected-metrics.jsonl

# 3. Update test expectations
# Recalculate golden dataset values based on new session data
```

## Notes

- **Input files** are real production session files from Claude Code
- **Expected output files** are real production metrics from CodeMie metrics system
- Files are in **JSONL format** (JSON Lines - one JSON object per line)
- Agent files are automatically discovered by matching `sessionId` field
- All files belong to the same conversation session (correlation by sessionId)
- Files contain sensitive paths (`/tmp/private`) but no credentials or secrets
- Expected metrics may have fewer deltas if generated before all agent files existed
